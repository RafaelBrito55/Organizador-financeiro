<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle Financeiro Anual - Simples</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --accent: #16a34a;
      --accent-soft: rgba(22, 163, 74, 0.08);
      --danger: #dc2626;
      --text: #111827;
      --text-soft: #6b7280;
      --border: #e5e7eb;
      --table-header: #f9fafb;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app-shell {
      max-width: 100%;        /* ocupa praticamente a tela toda */
      margin: 0 auto;
      padding: 1rem 2.5rem 2.5rem;  /* só uma margem lateral pra não colar na borda */
    }

    header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .title-group h1 {
      margin: 0;
      font-size: 1.7rem;
      letter-spacing: 0.02em;
    }

    .title-group p {
      margin: 0.35rem 0 0;
      font-size: 0.95rem;
      color: var(--text-soft);
    }

    .year-select {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    select {
      background: #ffffff;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.35rem 0.75rem;
      font-size: 0.9rem;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.7fr);
      gap: 1.25rem;
    }

    @media (max-width: 1024px) {
      main { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 1.1rem 1.25rem 1.25rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.05);
    }

    .card h2 {
      margin: 0 0 0.75rem;
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .card h2 span.label {
      font-size: 0.8rem;
      font-weight: 400;
      color: var(--text-soft);
    }

    .summary-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 720px) {
      .summary-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .summary-card {
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      padding: 0.6rem 0.75rem;
      background: linear-gradient(135deg, #ffffff, #f9fafb);
    }

    .summary-label {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 0.25rem;
    }

    .summary-value {
      font-size: 1.15rem;
      font-weight: 600;
    }

    .summary-extra {
      font-size: 0.8rem;
      margin-top: 0.1rem;
      color: var(--text-soft);
    }

    .summary-value.positivo { color: var(--accent); }
    .summary-value.negativo { color: var(--danger); }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid var(--border);
      margin-top: 0.25rem;
      background: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 650px;
      font-size: 0.8rem;
    }

    thead {
      background: var(--table-header);
      box-shadow: inset 0 -1px #e5e7eb;
    }

    th, td {
      padding: 0.5rem 0.6rem;
      text-align: right;
      border-bottom: 1px solid #edf0f3;
      white-space: nowrap;
    }

    th:first-child, td:first-child {
      text-align: left;
      position: sticky;
      left: 0;
      background: #ffffff;
      z-index: 1;
    }

    th {
      font-weight: 500;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.7rem;
    }

    tbody tr {
      transition: background 0.15s ease, transform 0.05s ease,
                  box-shadow 0.15s ease;
    }

    tbody tr:nth-child(even) td { background: #f9fafb; }

    tbody tr:hover td {
      background: #eef2ff;
      box-shadow: inset 0 0 0 9999px rgba(129, 140, 248, 0.06);
    }

    td.total { font-weight: 600; }
    td.saldo-positivo { color: var(--accent); font-weight: 600; }
    td.saldo-negativo { color: var(--danger); font-weight: 600; }

    .forms-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 0.75rem;
      margin: 0.75rem 0 0.5rem;
    }

    .form-card {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 0.6rem 0.8rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }

    .form-card-title {
      font-size: 0.82rem;
      color: var(--text);
      margin-bottom: 0.25rem;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      gap: 0.12rem;
    }

    .form-card-title .label {
      font-weight: 400;
      color: var(--text-soft);
      font-size: 0.76rem;
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      margin-bottom: 0.45rem;
    }

    label {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    input[type="number"],
    input[type="text"] {
      background: #ffffff;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.35rem 0.7rem;
      font-size: 0.8rem;
      width: 100%;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    select.form-select {
      background: #ffffff;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.35rem 0.7rem;
      font-size: 0.8rem;
      width: 100%;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.35rem 0.85rem;
      font-size: 0.8rem;
      cursor: pointer;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    button:hover { filter: brightness(0.95); background: rgba(22,163,74,0.15); }

    .btn-year {
      padding-inline: 0.6rem;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    .btn-small {
      padding: 0.25rem 0.55rem;
      font-size: 0.75rem;
    }

    .btn-outline {
      background: #ffffff;
      color: var(--text-soft);
      border: 1px solid #e5e7eb;
    }

    .btn-outline:hover {
      background: #f3f4f6;
      color: #4b5563;
    }

    .badge {
      padding: 0.12rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.72rem;
      background: #f9fafb;
      color: var(--text-soft);
    }

    .badge-ganho {
      color: var(--accent);
      border-color: rgba(22, 163, 74, 0.5);
      background: #ecfdf3;
    }

    .badge-gasto {
      color: var(--danger);
      border-color: rgba(220, 38, 38, 0.5);
      background: #fef2f2;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .chart-box {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 0.7rem;
      background: #ffffff;
    }

    .chart-title {
      font-size: 0.85rem;
      color: var(--text-soft);
      margin-bottom: 0.45rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .chart-box-inner {
      position: relative;
      height: 260px;
    }

    footer {
      margin-top: 1.75rem;
      font-size: 0.78rem;
      color: var(--text-soft);
      text-align: center;
    }

    /* Filtros de lançamentos */
    .filters-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 0.5rem;
      margin-top: 0.35rem;
    }

    .filter-field {
      display: flex;
      flex-direction: column;
      gap: 0.18rem;
      min-width: 150px;
      font-size: 0.78rem;
    }

    .filter-label {
      color: var(--text-soft);
      font-size: 0.75rem;
    }

    .filter-select {
      background: #ffffff;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0.3rem 0.7rem;
      font-size: 0.78rem;
      color: var(--text);
    }

    @media (max-width: 768px) {
      .filters-row {
        flex-direction: column;
        align-items: stretch;
      }
      .filter-field { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="title-group">
        <h1>Controle Financeiro Anual</h1>
        <p>Lança ganhos e gastos, corrige se precisar, e vê o resumo do ano.</p>
      </div>
      <div class="year-select">
        <span>Ano:</span>
        <select id="yearSelect"></select>
        <button type="button" id="btnAddYear" class="btn-year">+ Ano</button>
      </div>
    </header>

    <main>
      <!-- LADO ESQUERDO -->
      <section class="card">
        <h2>
          Resumo mensal
          <span class="label">Ganhos, gastos e saldo por mês</span>
        </h2>

        <div class="summary-row">
          <div class="summary-card">
            <div class="summary-label">Ganhos no ano</div>
            <div class="summary-value positivo" id="resumoGanhosAno">R$ 0,00</div>
            <div class="summary-extra" id="resumoGanhosMes">
              Média mensal: R$ 0,00
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Gastos no ano</div>
            <div class="summary-value negativo" id="resumoGastosAno">R$ 0,00</div>
            <div class="summary-extra" id="resumoGastosMes">
              Média mensal: R$ 0,00
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Saldo no ano</div>
            <div class="summary-value" id="resumoSaldoAno">R$ 0,00</div>
            <div class="summary-extra" id="resumoSaldoMes">
              Média mensal: R$ 0,00
            </div>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th><th>Mai</th><th>Jun</th>
                <th>Jul</th><th>Ago</th><th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
              </tr>
            </thead>
            <tbody id="tabelaResumo"></tbody>
          </table>
        </div>

        <h2 style="margin-top: 1.1rem;">
          Novo lançamento
          <span class="label">Preencha e clique em adicionar</span>
        </h2>

        <div class="forms-row">
          <div class="form-card">
            <div class="form-card-title">
              Adicionar ganho ou gasto
              <span class="label">
                Itens fixos (salário, aluguel etc.) podem ser aplicados para todos os meses.
              </span>
            </div>
            <form id="formLancamento">
              <div class="form-row">
                <label for="tipoLancamento">Tipo</label>
                <select id="tipoLancamento" class="form-select">
                  <option value="ganho">Ganho</option>
                  <option value="gasto">Gasto</option>
                </select>
              </div>
              <div class="form-row">
                <label for="mesLancamento">Mês</label>
                <select id="mesLancamento" class="form-select">
                  <option value="0">Jan</option>
                  <option value="1">Fev</option>
                  <option value="2">Mar</option>
                  <option value="3">Abr</option>
                  <option value="4">Mai</option>
                  <option value="5">Jun</option>
                  <option value="6">Jul</option>
                  <option value="7">Ago</option>
                  <option value="8">Set</option>
                  <option value="9">Out</option>
                  <option value="10">Nov</option>
                  <option value="11">Dez</option>
                </select>
              </div>
              <div class="form-row">
                <label for="categoriaLancamento">Categoria</label>
                <select id="categoriaLancamento" class="form-select"></select>
              </div>
              <div class="form-row">
                <label for="valorLancamento">Valor (R$)</label>
                <input id="valorLancamento" type="number" step="0.01" min="0" placeholder="Ex.: 250,00" required />
              </div>
              <div class="form-row">
                <label for="descricaoLancamento">Descrição (opcional)</label>
                <input id="descricaoLancamento" type="text" placeholder="Ex.: Gasolina, Mercado X, Bico de fim de semana..." />
              </div>
              <button type="submit">+ Adicionar lançamento</button>
            </form>
          </div>
        </div>

        <h2 style="margin-top: 1.1rem;">
          Lançamentos do ano
          <span class="label">Edite ou exclua se tiver digitado errado</span>
        </h2>

        <!-- Filtros -->
        <div class="filters-row">
          <div class="filter-field">
            <span class="filter-label">Tipo</span>
            <select id="filtroTipo" class="filter-select">
              <option value="todos">Todos</option>
              <option value="ganho">Ganhos</option>
              <option value="gasto">Gastos</option>
            </select>
          </div>

          <div class="filter-field">
            <span class="filter-label">Mês</span>
            <select id="filtroMes" class="filter-select">
              <option value="todos">Todos</option>
              <option value="0">Jan</option>
              <option value="1">Fev</option>
              <option value="2">Mar</option>
              <option value="3">Abr</option>
              <option value="4">Mai</option>
              <option value="5">Jun</option>
              <option value="6">Jul</option>
              <option value="7">Ago</option>
              <option value="8">Set</option>
              <option value="9">Out</option>
              <option value="10">Nov</option>
              <option value="11">Dez</option>
            </select>
          </div>

          <div class="filter-field">
            <span class="filter-label">Categoria</span>
            <select id="filtroCategoria" class="filter-select">
              <!-- opções preenchidas via JS -->
            </select>
          </div>

          <button type="button" id="btnLimparFiltros" class="btn-outline">
            Limpar filtros
          </button>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Mês</th>
                <th>Categoria</th>
                <th>Valor</th>
                <th>Descrição</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tabelaLancamentos"></tbody>
          </table>
        </div>
      </section>

      <!-- LADO DIREITO: GRÁFICOS -->
      <section class="card">
        <h2>
          Gráficos
          <span class="label">Visão rápida por categoria e mês</span>
        </h2>

        <div class="charts-grid">
          <div class="chart-box">
            <div class="chart-title">
              Gastos por categoria (barra)
              <span class="badge">Ano: <span id="anoLegenda1">–</span></span>
            </div>
            <div class="chart-box-inner">
              <canvas id="barGastosCategorias"></canvas>
            </div>
          </div>

          <div class="chart-box">
            <div class="chart-title">
              Ganhos x Gastos mensais (linha)
              <span class="badge">Ano atual</span>
            </div>
            <div class="chart-box-inner">
              <canvas id="lineGanhosGastos"></canvas>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      Conceito simples: cada linha é um lançamento. Itens fixos você replica pro ano todo com 1 clique.
    </footer>
  </div>

  <script>
    // ===== Categorias =====
    const categoriasGanhos = [
      "Salário",
      "Renda extra",
      "13º salário",
      "Férias",
      "Outros ganhos"
    ];

    const categoriasGastos = [
      "Aluguel",
      "Supermercado",
      "Combustível",
      "Despesas fixas",
      "Cartões de crédito",
      "Saúde",
      "Educação",
      "Lazer",
      "Impostos",
      "Outros gastos"
    ];

    const categoriasFixasGanhos = ["Salário", "13º salário", "Férias"];
    const categoriasFixasGastos = [
      "Aluguel",
      "Despesas fixas",
      "Cartões de crédito",
      "Saúde",
      "Educação",
      "Impostos"
    ];

    const mesesLabels = [
      "Jan", "Fev", "Mar", "Abr", "Mai", "Jun",
      "Jul", "Ago", "Set", "Out", "Nov", "Dez"
    ];

    // ano -> { lancamentos: [ {id,tipo,mes,categoria,valor,descricao} ] }
    const dadosPorAno = {};
    let nextId = 1;

    function formatarMoeda(valor) {
      return valor.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL"
      });
    }

    function garantirAno(ano) {
      const chave = String(ano);
      if (!dadosPorAno[chave]) {
        dadosPorAno[chave] = { lancamentos: [] };
      }
    }

    // cria/atualiza um lançamento único (tipo+mes+categoria)
    function upsertLancamento(ano, tipo, mes, categoria, valor, descricao) {
      garantirAno(ano);
      const lista = dadosPorAno[ano].lancamentos;
      const existente = lista.find(
        l => l.tipo === tipo && l.mes === mes && l.categoria === categoria
      );
      if (existente) {
        existente.valor = valor;
        existente.descricao = descricao;
      } else {
        lista.push({
          id: nextId++,
          tipo,
          mes,
          categoria,
          valor,
          descricao
        });
      }
    }

    // ===== Cálculos =====
    function calcularTotaisMes(ano) {
      garantirAno(ano);
      const lancamentos = dadosPorAno[ano].lancamentos || [];
      const ganhosMensais = Array(12).fill(0);
      const gastosMensais = Array(12).fill(0);

      lancamentos.forEach(l => {
        if (l.tipo === "ganho") ganhosMensais[l.mes] += l.valor;
        else gastosMensais[l.mes] += l.valor;
      });

      return { ganhosMensais, gastosMensais };
    }

    function calcularTotaisGastosPorCategoria(ano) {
      garantirAno(ano);
      const lancamentos = dadosPorAno[ano].lancamentos || [];
      const mapa = {};
      lancamentos.forEach(l => {
        if (l.tipo !== "gasto") return;
        mapa[l.categoria] = (mapa[l.categoria] || 0) + l.valor;
      });
      return mapa;
    }

    // ===== Resumo mensal =====
    function preencherTabelaResumo(ano) {
      const { ganhosMensais, gastosMensais } = calcularTotaisMes(ano);
      const tbody = document.getElementById("tabelaResumo");
      tbody.innerHTML = "";

      const linhaGanhos = document.createElement("tr");
      const linhaGastos = document.createElement("tr");
      const linhaSaldo = document.createElement("tr");

      linhaGanhos.innerHTML = '<td><strong>Ganhos</strong></td>';
      linhaGastos.innerHTML = '<td><strong>Gastos</strong></td>';
      linhaSaldo.innerHTML = '<td><strong>Saldo</strong></td>';

      ganhosMensais.forEach((ganho, idx) => {
        const gasto = gastosMensais[idx];
        const saldo = ganho - gasto;

        const tdG = document.createElement("td");
        tdG.textContent = formatarMoeda(ganho);
        linhaGanhos.appendChild(tdG);

        const tdGt = document.createElement("td");
        tdGt.textContent = formatarMoeda(gasto);
        linhaGastos.appendChild(tdGt);

        const tdS = document.createElement("td");
        tdS.textContent = formatarMoeda(saldo);
        tdS.classList.add(saldo >= 0 ? "saldo-positivo" : "saldo-negativo");
        linhaSaldo.appendChild(tdS);
      });

      tbody.appendChild(linhaGanhos);
      tbody.appendChild(linhaGastos);
      tbody.appendChild(linhaSaldo);

      const totalGanhosAno = ganhosMensais.reduce((a, b) => a + b, 0);
      const totalGastosAno = gastosMensais.reduce((a, b) => a + b, 0);
      const totalSaldoAno = totalGanhosAno - totalGastosAno;

      document.getElementById("resumoGanhosAno").textContent =
        formatarMoeda(totalGanhosAno);
      document.getElementById("resumoGastosAno").textContent =
        formatarMoeda(totalGastosAno);
      document.getElementById("resumoSaldoAno").textContent =
        formatarMoeda(totalSaldoAno);

      document.getElementById("resumoGanhosMes").textContent =
        `Média mensal: ${formatarMoeda(totalGanhosAno / 12)}`;
      document.getElementById("resumoGastosMes").textContent =
        `Média mensal: ${formatarMoeda(totalGastosAno / 12)}`;
      document.getElementById("resumoSaldoMes").textContent =
        `Média mensal: ${formatarMoeda(totalSaldoAno / 12)}`;
    }

    // ===== Tabela de lançamentos (com filtros) =====
    function preencherTabelaLancamentos(ano) {
      garantirAno(ano);
      const tbody = document.getElementById("tabelaLancamentos");
      tbody.innerHTML = "";

      const lista = dadosPorAno[ano].lancamentos || [];

      const filtroTipoEl = document.getElementById("filtroTipo");
      const filtroMesEl = document.getElementById("filtroMes");
      const filtroCatEl = document.getElementById("filtroCategoria");

      const tipoFiltro = filtroTipoEl ? filtroTipoEl.value : "todos";
      const mesFiltro = filtroMesEl ? filtroMesEl.value : "todos";
      const catFiltro = filtroCatEl ? filtroCatEl.value : "todas";

      const filtrados = lista.filter(l => {
        const okTipo = tipoFiltro === "todos" || l.tipo === tipoFiltro;
        const okMes =
          mesFiltro === "todos" || l.mes === parseInt(mesFiltro, 10);
        const okCat =
          catFiltro === "todas" || l.categoria === catFiltro;
        return okTipo && okMes && okCat;
      });

      if (!filtrados.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.textContent = "Nenhum lançamento com os filtros atuais.";
        td.style.textAlign = "center";
        td.style.color = "#9ca3af";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      filtrados
        .slice()
        .sort((a, b) => a.mes - b.mes || a.id - b.id)
        .forEach(l => {
          const tr = document.createElement("tr");

          const tdTipo = document.createElement("td");
          const spanTipo = document.createElement("span");
          spanTipo.className =
            "badge " + (l.tipo === "ganho" ? "badge-ganho" : "badge-gasto");
          spanTipo.textContent = l.tipo === "ganho" ? "Ganho" : "Gasto";
          tdTipo.appendChild(spanTipo);
          tr.appendChild(tdTipo);

          const tdMes = document.createElement("td");
          tdMes.textContent = mesesLabels[l.mes];
          tr.appendChild(tdMes);

          const tdCat = document.createElement("td");
          tdCat.textContent = l.categoria;
          tr.appendChild(tdCat);

          const tdValor = document.createElement("td");
          tdValor.textContent = formatarMoeda(l.valor);
          tr.appendChild(tdValor);

          const tdDesc = document.createElement("td");
          tdDesc.textContent = l.descricao || "";
          tr.appendChild(tdDesc);

          const tdAcoes = document.createElement("td");
          const btnEditar = document.createElement("button");
          btnEditar.textContent = "Editar";
          btnEditar.className = "btn-small";
          btnEditar.dataset.action = "editar";
          btnEditar.dataset.id = String(l.id);

          const btnExcluir = document.createElement("button");
          btnExcluir.textContent = "Excluir";
          btnExcluir.className = "btn-small";
          btnExcluir.style.marginLeft = "0.35rem";
          btnExcluir.dataset.action = "excluir";
          btnExcluir.dataset.id = String(l.id);

          tdAcoes.appendChild(btnEditar);
          tdAcoes.appendChild(btnExcluir);
          tr.appendChild(tdAcoes);

          tbody.appendChild(tr);
        });
    }

    // ===== Gráficos =====
    let barChartInstance = null;
    let lineChartInstance = null;

    function atualizarGraficos(ano) {
      const { ganhosMensais, gastosMensais } = calcularTotaisMes(ano);
      const mapaGastosCat = calcularTotaisGastosPorCategoria(ano);

      const barCtx = document
        .getElementById("barGastosCategorias")
        .getContext("2d");
      if (barChartInstance) barChartInstance.destroy();
      barChartInstance = new Chart(barCtx, {
        type: "bar",
        data: {
          labels: Object.keys(mapaGastosCat),
          datasets: [
            { label: "Gastos (R$ / ano)", data: Object.values(mapaGastosCat) }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: "#4b5563", font: { size: 11 } }
            }
          },
          scales: {
            x: {
              ticks: { color: "#6b7280", font: { size: 10 } },
              grid: { display: false }
            },
            y: {
              ticks: {
                color: "#6b7280",
                font: { size: 10 },
                callback: val =>
                  val.toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL",
                    maximumFractionDigits: 0
                  })
              },
              grid: { color: "#e5e7eb" }
            }
          }
        }
      });

      const lineCtx = document
        .getElementById("lineGanhosGastos")
        .getContext("2d");
      if (lineChartInstance) lineChartInstance.destroy();
      lineChartInstance = new Chart(lineCtx, {
        type: "line",
        data: {
          labels: mesesLabels,
          datasets: [
            { label: "Ganhos", data: ganhosMensais, tension: 0.3 },
            { label: "Gastos", data: gastosMensais, tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: "#4b5563", font: { size: 11 } }
            }
          },
          scales: {
            x: {
              ticks: { color: "#6b7280", font: { size: 10 } },
              grid: { display: false }
            },
            y: {
              ticks: {
                color: "#6b7280",
                font: { size: 10 },
                callback: val =>
                  val.toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL",
                    maximumFractionDigits: 0
                  })
              },
              grid: { color: "#e5e7eb" }
            }
          }
        }
      });

      document.getElementById("anoLegenda1").textContent = ano;
    }

    // ===== Formulário de lançamentos =====
    function atualizarOpcoesCategoria() {
      const tipo = document.getElementById("tipoLancamento").value;
      const selectCat = document.getElementById("categoriaLancamento");
      selectCat.innerHTML = "";

      const lista = tipo === "ganho" ? categoriasGanhos : categoriasGastos;
      lista.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        selectCat.appendChild(opt);
      });
    }

    function configurarFormLancamento() {
      const form = document.getElementById("formLancamento");
      const yearSelect = document.getElementById("yearSelect");

      document
        .getElementById("tipoLancamento")
        .addEventListener("change", atualizarOpcoesCategoria);

      form.addEventListener("submit", e => {
        e.preventDefault();
        const ano = yearSelect.value;
        if (!ano) return;

        const tipo = document.getElementById("tipoLancamento").value;
        const mes = parseInt(
          document.getElementById("mesLancamento").value,
          10
        );
        const categoria =
          document.getElementById("categoriaLancamento").value;
        const valorStr =
          document.getElementById("valorLancamento").value;
        const desc =
          document.getElementById("descricaoLancamento").value.trim();

        let valor = parseFloat(valorStr.replace(",", "."));
        if (isNaN(valor) || valor < 0) {
          alert("Valor inválido.");
          return;
        }

        const ehFixa =
          (tipo === "ganho" &&
            categoriasFixasGanhos.includes(categoria)) ||
          (tipo === "gasto" &&
            categoriasFixasGastos.includes(categoria));

        if (ehFixa) {
          const aplicarTodos = confirm(
            `Aplicar este valor de "${categoria}" para todos os meses do ano?`
          );
          if (aplicarTodos) {
            for (let m = 0; m < 12; m++) {
              upsertLancamento(ano, tipo, m, categoria, valor, desc);
            }
          } else {
            upsertLancamento(ano, tipo, mes, categoria, valor, desc);
          }
        } else {
          upsertLancamento(ano, tipo, mes, categoria, valor, desc);
        }

        form.reset();
        document.getElementById("tipoLancamento").value = "ganho";
        atualizarOpcoesCategoria();
        atualizarAnoAtual();
      });
    }

    // ===== Filtros de lançamentos =====
    function preencherFiltroCategoria() {
      const filtroCatEl = document.getElementById("filtroCategoria");
      if (!filtroCatEl) return;

      filtroCatEl.innerHTML = "";
      const optTodas = document.createElement("option");
      optTodas.value = "todas";
      optTodas.textContent = "Todas";
      filtroCatEl.appendChild(optTodas);

      const todasCategorias = [...categoriasGanhos, ...categoriasGastos];
      todasCategorias.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        filtroCatEl.appendChild(opt);
      });
    }

    function configurarFiltrosLancamentos() {
      const filtroTipoEl = document.getElementById("filtroTipo");
      const filtroMesEl = document.getElementById("filtroMes");
      const filtroCatEl = document.getElementById("filtroCategoria");
      const btnLimpar = document.getElementById("btnLimparFiltros");
      const yearSelect = document.getElementById("yearSelect");

      const atualizar = () => {
        const ano = yearSelect.value;
        if (!ano) return;
        preencherTabelaLancamentos(ano);
      };

      filtroTipoEl.addEventListener("change", atualizar);
      filtroMesEl.addEventListener("change", atualizar);
      filtroCatEl.addEventListener("change", atualizar);

      btnLimpar.addEventListener("click", () => {
        filtroTipoEl.value = "todos";
        filtroMesEl.value = "todos";
        filtroCatEl.value = "todas";
        atualizar();
      });
    }

    // ===== Eventos da tabela de lançamentos (editar/excluir) =====
    function configurarTabelaLancamentosEventos() {
      const tbody = document.getElementById("tabelaLancamentos");
      const yearSelect = document.getElementById("yearSelect");

      tbody.addEventListener("click", e => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const action = btn.dataset.action;
        const id = parseInt(btn.dataset.id, 10);
        const ano = yearSelect.value;
        if (!ano) return;
        garantirAno(ano);

        const lista = dadosPorAno[ano].lancamentos;
        const idx = lista.findIndex(l => l.id === id);
        if (idx === -1) return;

        if (action === "editar") {
          const atual = lista[idx];
          const novoValorStr = prompt(
            `Novo valor para ${atual.categoria} / ${mesesLabels[atual.mes]}:`,
            atual.valor.toString().replace(".", ",")
          );
          if (novoValorStr === null) return;
          let novoValor = parseFloat(novoValorStr.replace(",", "."));
          if (isNaN(novoValor) || novoValor < 0) {
            alert("Valor inválido.");
            return;
          }
          lista[idx].valor = novoValor;
          atualizarAnoAtual();
        }

        if (action === "excluir") {
          const ok = confirm("Deseja realmente excluir este lançamento?");
          if (!ok) return;
          lista.splice(idx, 1);
          atualizarAnoAtual();
        }
      });
    }

    // ===== Anos =====
    function atualizarAnoAtual() {
      const ano = document.getElementById("yearSelect").value;
      if (!ano) return;
      garantirAno(ano);
      preencherTabelaResumo(ano);
      preencherTabelaLancamentos(ano);
      atualizarGraficos(ano);
    }

    function popularSelectAnos(selectedAno = null) {
      const yearSelect = document.getElementById("yearSelect");
      yearSelect.innerHTML = "";

      const anos = Object.keys(dadosPorAno)
        .map(n => parseInt(n, 10))
        .sort((a, b) => a - b);

      anos.forEach(ano => {
        const opt = document.createElement("option");
        opt.value = String(ano);
        opt.textContent = String(ano);
        yearSelect.appendChild(opt);
      });

      if (!anos.length) return;

      const anoSelecionado = selectedAno || String(anos[anos.length - 1]);
      yearSelect.value = anoSelecionado;
    }

    function configurarBotaoAddAno() {
      const btnAddYear = document.getElementById("btnAddYear");
      const yearSelect = document.getElementById("yearSelect");

      btnAddYear.addEventListener("click", () => {
        const entrada = prompt("Digite o ano que deseja criar (ex.: 2026):");
        if (!entrada) return;
        const novoAno = parseInt(entrada, 10);
        if (isNaN(novoAno) || novoAno < 1900 || novoAno > 9999) {
          alert("Ano inválido.");
          return;
        }
        garantirAno(novoAno);
        popularSelectAnos(String(novoAno));
        atualizarAnoAtual();
      });

      yearSelect.addEventListener("change", atualizarAnoAtual);
    }

    // ===== Init =====
    document.addEventListener("DOMContentLoaded", () => {
      const anoAtual = new Date().getFullYear();
      garantirAno(anoAtual);
      popularSelectAnos(String(anoAtual));

      configurarFormLancamento();
      configurarTabelaLancamentosEventos();
      configurarBotaoAddAno();
      atualizarOpcoesCategoria();
      preencherFiltroCategoria();
      configurarFiltrosLancamentos();
      atualizarAnoAtual();
    });
  </script>
</body>
</html>
